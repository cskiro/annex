name: Auto-Generate Skill from Pattern

on:
  issues:
    types: [labeled]

jobs:
  generate-skill:
    # Only run when both required labels are present
    if: contains(github.event.issue.labels.*.name, 'pattern-learning') && contains(github.event.issue.labels.*.name, 'skill-needed')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout claudex repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git
        run: |
          git config --global user.name "Pattern Suggestion Bot"
          git config --global user.email "noreply@anthropic.com"

      - name: Generate skill from issue
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDEX_PATH: ${{ github.workspace }}
        run: |
          chmod +x scripts/automation/generate-skill-from-issue.sh

          # Run the script and capture output
          output=$(scripts/automation/generate-skill-from-issue.sh ${{ github.event.issue.number }} 2>&1)
          echo "$output"

          # Extract PR URL from output
          pr_url=$(echo "$output" | grep -oE "https://github.com/[^/]+/[^/]+/pull/[0-9]+" | tail -1)
          pr_number=$(echo "$pr_url" | grep -oE "[0-9]+$")

          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

      - name: Comment on issue with PR link
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const pr_url = '${{ steps.generate.outputs.pr_url }}';
            const pr_number = '${{ steps.generate.outputs.pr_number }}';

            let body = '‚úÖ Skill auto-generated successfully!\n\n';

            if (pr_url && pr_number) {
              body += `**Pull Request:** #${pr_number}\n${pr_url}\n\n`;
            }

            body += `**Next Steps:**\n`;
            body += `1. Review the generated skill in the PR\n`;
            body += `2. Test the skill functionality\n`;
            body += `3. Merge the PR if everything looks good\n\n`;
            body += `ü§ñ Auto-generated by Pattern Suggestion Pipeline`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: body
            });

      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `‚ùå Skill generation failed. Please check the workflow logs for details.\n\nCommon issues:\n- Pattern metadata missing from issue body\n- Skill name conflicts\n- Repository permissions\n\nü§ñ Auto-generated by Pattern Suggestion Pipeline`
            });
