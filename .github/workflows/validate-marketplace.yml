name: Validate Marketplace

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Marketplace Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Validate marketplace.json schema
        run: |
          echo "ğŸ“‹ Validating marketplace.json schema..."
          python3 .claude-plugin/validate-marketplace.py

      - name: Check plugin manifests exist
        run: |
          echo "ğŸ“¦ Checking plugin manifests..."
          for plugin in codebase-auditor bulletproof-react-auditor claude-md-auditor cc-insights; do
            if [ ! -f "$plugin/plugin.json" ]; then
              echo "âŒ Missing plugin.json in $plugin"
              exit 1
            else
              echo "âœ… Found plugin.json in $plugin"
            fi
          done

      - name: Validate plugin.json files
        run: |
          echo "ğŸ” Validating plugin.json files..."
          for plugin in codebase-auditor bulletproof-react-auditor claude-md-auditor cc-insights; do
            if ! python3 -m json.tool "$plugin/plugin.json" > /dev/null; then
              echo "âŒ Invalid JSON in $plugin/plugin.json"
              exit 1
            else
              echo "âœ… Valid JSON in $plugin/plugin.json"
            fi
          done

      - name: Validate SKILL.md files exist
        run: |
          echo "ğŸ“ Checking SKILL.md files..."
          for plugin in codebase-auditor bulletproof-react-auditor claude-md-auditor cc-insights; do
            if [ ! -f "$plugin/SKILL.md" ]; then
              echo "âŒ Missing SKILL.md in $plugin"
              exit 1
            else
              echo "âœ… Found SKILL.md in $plugin"
            fi
          done

      - name: Check README files
        run: |
          echo "ğŸ“š Checking README files..."
          for plugin in codebase-auditor bulletproof-react-auditor claude-md-auditor cc-insights; do
            if [ ! -f "$plugin/README.md" ]; then
              echo "âš ï¸  Missing README.md in $plugin"
            else
              echo "âœ… Found README.md in $plugin"
            fi
          done

      - name: Check CHANGELOG files
        run: |
          echo "ğŸ“‹ Checking CHANGELOG files..."
          for plugin in codebase-auditor bulletproof-react-auditor claude-md-auditor cc-insights; do
            if [ ! -f "$plugin/CHANGELOG.md" ]; then
              echo "âš ï¸  Missing CHANGELOG.md in $plugin"
            else
              echo "âœ… Found CHANGELOG.md in $plugin"
            fi
          done

      - name: Validate marketplace.json syntax
        run: |
          echo "ğŸ”§ Validating marketplace.json JSON syntax..."
          if ! python3 -m json.tool .claude-plugin/marketplace.json > /dev/null; then
            echo "âŒ Invalid JSON in marketplace.json"
            exit 1
          else
            echo "âœ… Valid JSON in marketplace.json"
          fi

      - name: Check for required marketplace fields
        run: |
          echo "ğŸ“‹ Checking required marketplace fields..."
          python3 -c "
import json
import sys

with open('.claude-plugin/marketplace.json', 'r') as f:
    data = json.load(f)

required_fields = ['name', 'owner', 'plugins']
missing = [f for f in required_fields if f not in data]

if missing:
    print(f'âŒ Missing required fields: {missing}')
    sys.exit(1)

if not isinstance(data.get('plugins', []), list):
    print('âŒ plugins must be an array')
    sys.exit(1)

if len(data.get('plugins', [])) == 0:
    print('âš ï¸  No plugins defined')

print(f\"âœ… Marketplace validation passed ({len(data.get('plugins', []))} plugins)\")
"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All marketplace validations passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Marketplace: claudex"
          echo "Plugins validated: 4"
          echo "  â€¢ codebase-auditor"
          echo "  â€¢ bulletproof-react-auditor"
          echo "  â€¢ claude-md-auditor"
          echo "  â€¢ cc-insights"
          echo ""
