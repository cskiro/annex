#!/bin/bash

# Generate Skill from GitHub Issue
# Automates skill creation from pattern detection issues
# Part of Pattern Suggestion Pipeline - Phase 1.4

set -euo pipefail

# Configuration
CLAUDEX_REPO="cskiro/claudex"
CLAUDEX_PATH="${CLAUDEX_PATH:-$HOME/Desktop/Development/claudex}"
LOG_FILE="$HOME/.claude/logs/skill-generation.log"
DB_PATH="$HOME/.claude/packages/@claude/utils/src/database/data/unified.db"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Function to extract value from issue body
extract_field() {
    local issue_body="$1"
    local field_name="$2"

    # Match pattern: **Field Name:** `value` or **Field Name:** value
    echo "$issue_body" | grep -o "\*\*${field_name}:\*\* \`[^\`]*\`" | sed "s/\*\*${field_name}:\*\* \`//; s/\`//" || \
    echo "$issue_body" | grep -o "\*\*${field_name}:\*\* [^*]*" | sed "s/\*\*${field_name}:\*\* //" | head -1
}

# Function to extract metrics table value
extract_metric() {
    local issue_body="$1"
    local metric_name="$2"

    echo "$issue_body" | grep "| ${metric_name}" | grep -oE "[0-9]+[Ã—%]" | head -1 | tr -d 'Ã—%'
}

# Function to parse issue and extract pattern metadata
parse_issue() {
    local issue_number="$1"

    log_message "PARSE: Fetching issue #${issue_number} from ${CLAUDEX_REPO}"

    # Fetch issue body
    local issue_body=$(gh issue view "$issue_number" --repo "$CLAUDEX_REPO" --json body --jq '.body' 2>&1)

    if [ -z "$issue_body" ]; then
        echo -e "${RED}âŒ Error: Could not fetch issue #${issue_number}${NC}" >&2
        return 1
    fi

    # Extract fields
    PATTERN_TEXT=$(extract_field "$issue_body" "Pattern")
    SUGGESTED_NAME=$(extract_field "$issue_body" "Suggested Skill Name")
    DOMAIN=$(extract_field "$issue_body" "Domain")
    USAGE_COUNT=$(extract_metric "$issue_body" "Usage Count")
    SUCCESS_RATE=$(extract_metric "$issue_body" "Success Rate")

    # Validate extracted data
    if [ -z "$SUGGESTED_NAME" ] || [ -z "$PATTERN_TEXT" ]; then
        echo -e "${RED}âŒ Error: Failed to parse required fields from issue${NC}" >&2
        log_message "ERROR: Missing required fields (suggested_name or pattern_text)"
        return 1
    fi

    log_message "PARSE: Successfully extracted pattern metadata"
    log_message "  Pattern: ${PATTERN_TEXT}"
    log_message "  Skill Name: ${SUGGESTED_NAME}"
    log_message "  Domain: ${DOMAIN}"

    return 0
}

# Function to check if skill already exists
check_skill_exists() {
    local skill_name="$1"
    local skill_dir="$CLAUDEX_PATH/skills/$skill_name"

    if [ -d "$skill_dir" ]; then
        echo -e "${YELLOW}âš ï¸  Warning: Skill directory already exists: ${skill_dir}${NC}" >&2
        log_message "WARNING: Skill already exists at ${skill_dir}"
        return 1
    fi

    return 0
}

# Function to generate skill files
generate_skill_files() {
    local skill_name="$1"
    local pattern_text="$2"
    local usage_count="$3"
    local success_rate="$4"
    local domain="$5"
    local issue_number="$6"
    local skill_dir="$CLAUDEX_PATH/skills/$skill_name"

    log_message "GENERATE: Creating skill directory: ${skill_dir}"
    mkdir -p "$skill_dir"

    # Generate SKILL.md
    cat > "$skill_dir/SKILL.md" <<EOF
---
name: $skill_name
version: 0.1.0
description: Automated best practice based on pattern: "$pattern_text"
author: Pattern Suggestion Pipeline
---

# $skill_name

## Overview

This skill automates the best practice: "$pattern_text"

**Success Rate:** ${success_rate}%
**Usage Count:** ${usage_count}Ã—
**Domain:** ${domain}

## When to Use This Skill

**Trigger Phrases:**
- "$pattern_text"

**Use Cases:**
- Ensuring best practices are followed
- Automating repetitive validations
- Reducing errors

## Response Style

- **Proactive**: Check before acting
- **Informative**: Explain what's being validated
- **Helpful**: Provide clear next steps

## Workflow

1. Identify the context where this pattern applies
2. Execute the validation/check
3. Handle success case
4. Handle error case with helpful message

## Generated By

ğŸ¤– Pattern Suggestion Pipeline
Detected from ${usage_count} successful applications with ${success_rate}% success rate

**Source Issue:** #${issue_number}

## Note

This skill was auto-generated from a detected pattern. Review and enhance as needed before production use.
EOF

    # Generate README.md
    cat > "$skill_dir/README.md" <<EOF
# $skill_name

Automated best practice: "$pattern_text"

## Installation

\`\`\`bash
/plugin install $skill_name
\`\`\`

## Usage

Simply mention the trigger phrase and the skill will activate:

- "$pattern_text"

## Metrics

- **Success Rate:** ${success_rate}%
- **Usage Count:** ${usage_count}Ã—
- **Category:** ${domain}

## Generated

This skill was automatically generated by the Pattern Suggestion Pipeline based on proven patterns from the double-helix intelligence system.

**GitHub Issue:** https://github.com/${CLAUDEX_REPO}/issues/${issue_number}
EOF

    # Generate plugin.json
    cat > "$skill_dir/plugin.json" <<EOF
{
  "name": "$skill_name",
  "version": "0.1.0",
  "description": "Automated best practice: $pattern_text",
  "author": "Pattern Suggestion Pipeline",
  "components": {
    "agents": [
      {
        "name": "$skill_name",
        "manifestPath": "SKILL.md"
      }
    ]
  },
  "metadata": {
    "category": "productivity",
    "status": "proof-of-concept",
    "tags": ["${domain}", "automation", "best-practice", "pattern-generated"]
  }
}
EOF

    log_message "GENERATE: Skill files created successfully"
    echo -e "${GREEN}âœ… Generated skill files:${NC}"
    echo "   - SKILL.md"
    echo "   - README.md"
    echo "   - plugin.json"

    return 0
}

# Function to create feature branch and commit
commit_skill() {
    local skill_name="$1"
    local pattern_text="$2"
    local success_rate="$3"
    local usage_count="$4"
    local issue_number="$5"
    local branch_name="feature/pattern-${skill_name}"

    cd "$CLAUDEX_PATH"

    # Ensure we're on main and up to date
    log_message "GIT: Ensuring main branch is up to date"
    git checkout main 2>&1 | tee -a "$LOG_FILE"
    git pull origin main 2>&1 | tee -a "$LOG_FILE"

    # Check if branch already exists
    if git rev-parse --verify "$branch_name" &>/dev/null; then
        echo -e "${YELLOW}âš ï¸  Warning: Branch ${branch_name} already exists${NC}" >&2
        log_message "WARNING: Branch already exists: ${branch_name}"

        # Delete existing branch
        git branch -D "$branch_name" 2>&1 | tee -a "$LOG_FILE"
        log_message "GIT: Deleted existing branch"
    fi

    # Create new branch
    log_message "GIT: Creating feature branch: ${branch_name}"
    git checkout -b "$branch_name" 2>&1 | tee -a "$LOG_FILE"

    # Stage changes
    git add "skills/$skill_name"

    # Commit with detailed message
    log_message "GIT: Committing skill files"
    git commit -m "$(cat <<EOF
feat: Add $skill_name from pattern detection

Pattern: $pattern_text
Success Rate: ${success_rate}%
Usage Count: ${usage_count}Ã—

Generated by Pattern Suggestion Pipeline
Closes #${issue_number}

ğŸ¤– Auto-generated skill

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)" 2>&1 | tee -a "$LOG_FILE"

    echo -e "${GREEN}âœ… Changes committed to branch${NC}"
    log_message "GIT: Commit successful"

    return 0
}

# Function to ensure PR labels exist
ensure_pr_labels_exist() {
    local required_labels=("auto-generated:B4A7D6:Automatically generated by pipeline"
                           "skill:0052CC:Skill implementation PR")

    log_message "LABELS: Checking PR labels exist"

    for label_spec in "${required_labels[@]}"; do
        IFS=':' read -r label_name label_color label_desc <<< "$label_spec"

        # Check if label exists
        if ! gh label list --repo "$CLAUDEX_REPO" | grep -q "^${label_name}"; then
            log_message "LABELS: Creating missing label '${label_name}'"
            gh label create "$label_name" \
                --repo "$CLAUDEX_REPO" \
                --description "$label_desc" \
                --color "$label_color" &> /dev/null || true
        fi
    done

    log_message "LABELS: All PR labels verified"
}

# Function to push branch and create PR
create_pull_request() {
    local skill_name="$1"
    local pattern_text="$2"
    local issue_number="$3"
    local branch_name="feature/pattern-${skill_name}"

    cd "$CLAUDEX_PATH"

    # Push branch
    log_message "GIT: Pushing branch to origin"
    git push -u origin "$branch_name" 2>&1 | tee -a "$LOG_FILE"

    # Ensure PR labels exist
    ensure_pr_labels_exist

    # Create PR
    log_message "PR: Creating pull request"

    local pr_body="## Auto-Generated Skill

This PR adds a new skill generated from pattern detection.

**Pattern:** $pattern_text

### Generated Files
- \`skills/$skill_name/SKILL.md\` - Agent manifest
- \`skills/$skill_name/README.md\` - User documentation
- \`skills/$skill_name/plugin.json\` - Marketplace metadata

### Review Checklist
- [ ] Skill manifest follows template standards
- [ ] Documentation is clear and accurate
- [ ] Metadata is correctly configured
- [ ] Skill name follows naming conventions

### Next Steps
1. Review generated files for quality
2. Test skill functionality
3. Merge if approved or request changes

---

ğŸ¤– Auto-generated by Pattern Suggestion Pipeline
Closes #${issue_number}"

    local pr_url=$(gh pr create \
        --repo "$CLAUDEX_REPO" \
        --base main \
        --head "$branch_name" \
        --title "feat: Add $skill_name from pattern detection" \
        --body "$pr_body" \
        --label "auto-generated,skill" \
        2>&1)

    if [ -z "$pr_url" ]; then
        echo -e "${RED}âŒ Error: Failed to create pull request${NC}" >&2
        log_message "ERROR: PR creation failed"
        return 1
    fi

    log_message "PR: Successfully created: ${pr_url}"
    echo -e "${GREEN}âœ… Pull request created:${NC}"
    echo "   $pr_url"

    return 0
}

# Main execution
main() {
    if [ $# -eq 0 ]; then
        echo "Usage: $0 <issue-number>"
        echo ""
        echo "Example:"
        echo "  $0 13"
        exit 1
    fi

    local issue_number="$1"

    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}Auto-Generating Skill from Issue #${issue_number}${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # Validate claudex path
    if [ ! -d "$CLAUDEX_PATH" ]; then
        echo -e "${RED}âŒ Error: claudex repository not found at: $CLAUDEX_PATH${NC}"
        echo "   Set CLAUDEX_PATH environment variable to correct location"
        exit 1
    fi

    # Parse issue
    if ! parse_issue "$issue_number"; then
        exit 1
    fi

    echo ""
    echo -e "${GREEN}ğŸ“‹ Pattern Details:${NC}"
    echo "   Pattern: $PATTERN_TEXT"
    echo "   Skill Name: $SUGGESTED_NAME"
    echo "   Domain: $DOMAIN"
    echo "   Success Rate: ${SUCCESS_RATE}%"
    echo "   Usage Count: ${USAGE_COUNT}Ã—"
    echo ""

    # Check if skill already exists
    if ! check_skill_exists "$SUGGESTED_NAME"; then
        echo -e "${YELLOW}   Overwriting existing skill...${NC}"
    fi

    # Generate skill files
    if ! generate_skill_files "$SUGGESTED_NAME" "$PATTERN_TEXT" "$USAGE_COUNT" "$SUCCESS_RATE" "$DOMAIN" "$issue_number"; then
        exit 1
    fi

    echo ""

    # Commit changes
    if ! commit_skill "$SUGGESTED_NAME" "$PATTERN_TEXT" "$SUCCESS_RATE" "$USAGE_COUNT" "$issue_number"; then
        exit 1
    fi

    echo ""

    # Create PR
    if ! create_pull_request "$SUGGESTED_NAME" "$PATTERN_TEXT" "$issue_number"; then
        exit 1
    fi

    echo ""
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… Skill Generation Complete!${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    log_message "SUCCESS: Skill generation completed for issue #${issue_number}"
}

# Run main
main "$@"
